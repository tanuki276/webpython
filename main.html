<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>liefantidia | æ­´å²çš„æ——ãƒ»ç´‹ç« æ¤œç´¢</title> 
    
    <style>
        /* (å‰å›ã®å›ç­”ã§æç¤ºã•ã‚ŒãŸCSSã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„) */
    </style>
</head>
<body>

    <header>
        <h1>liefantidia | æ­´å²çš„æ——ãƒ»ç´‹ç« æ¤œç´¢</h1> 
        <p>å›½åã€æ”¿ä½“åã€ã¾ãŸã¯æ——ã®ç¨®é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å¹´å·æŒ‡å®šã¯ç¾åœ¨éå¯¾å¿œã§ã™ã€‚</p>
    </header>

    <main>
        <section class="search-controls">
            <input type="text" id="keyword-input" placeholder="å›½åã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: æ¸…æœ, ãƒ‰ã‚¤ãƒ„)" aria-label="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢">
            
            <input type="number" id="year-input" placeholder="å¹´å· (éå¯¾å¿œ)" min="1" max="2025" aria-label="å¹´å·æŒ‡å®š" style="display: none;">
            
            <select id="flag-type-select" aria-label="æ——ã®ç¨®é¡é¸æŠ">
                <option value="">å…¨ã¦ã®ç¨®é¡ (æ——ã¨ç´‹ç« )</option>
                <option value="å›½æ——">å›½æ——</option>
                <option value="è»æ——">è»æ——</option>
                <option value="å•†èˆ¹æ——">å•†èˆ¹æ——</option>
                <option value="æ”¿å…šæ——">æ”¿å…šæ——</option>
                <option value="å›½ç« ">å›½ç« </option>
                <option value="è»è‰¦æ——">è»è‰¦æ——</option>
            </select>

            <button id="search-button">æ¤œç´¢</button>
        </section>

        <section class="results-area">
            <h2>æ¤œç´¢çµæœ (<span id="result-count">0</span>ä»¶)</h2>
            <p id="loading-message" class="hidden">æ¤œç´¢ä¸­... (Wikidata Query Serviceã«ç›´æ¥å•ã„åˆã‚ã›ã¦ã„ã¾ã™)</p>
            <p id="error-message" class="hidden error">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã€æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>
            
            <div id="flags-container" class="flags-grid">
            </div>

            <h2 style="margin-top: 40px;">Wikipedia Summary (ä»£è¡¨çš„ãªè¨˜äº‹)</h2>
            <div id="summary-container" style="padding: 20px; background-color: #fff; border-radius: 8px;">
                <p id="summary-title">è¨˜äº‹æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <div id="summary-content"></div>
            </div>
        </section>
    </main>

    <footer>
        <p>ãƒ‡ãƒ¼ã‚¿ã¯**Wikidata**ãŠã‚ˆã³**Wikimedia Commons**ã‹ã‚‰å–å¾—ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
        <p>è‡ªç”±ãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã«åŸºã¥ãè¡¨ç¤ºã—ã¦ã„ã¾ã™ãŒã€**å¿…ãšå„ã‚«ãƒ¼ãƒ‰ã®å‡ºå…¸ã‚’ã”ç¢ºèªãã ã•ã„ã€‚**</p>
    </footer>

    <script>
        const WIKIDATA_ENDPOINT = 'https://query.wikidata.org/sparql';

        // =======================================================
        // ğŸ› ï¸ Wikidata SPARQLã‚¯ã‚¨ãƒª (è¤‡æ•°ã®æ——ã‚’å–å¾—)
        // =======================================================
        
        function generateSparqlQuery(keyword, year, type) {
            if (!keyword) return null;
            
            const sparqlQuery = `
                SELECT DISTINCT 
                    ?item ?itemLabel ?image ?licenseLabel ?authorLabel
                    (SAMPLE(?startDate) AS ?start)
                    (SAMPLE(?endDate) AS ?end)
                    (SAMPLE(?type) AS ?typeLabel)
                WHERE {
                    { ?item wdt:P31/wdt:P279* wd:Q1197825. }
                    UNION
                    { ?item wdt:P31/wdt:P279* wd:Q1529158. }
                    
                    { ?item wdt:P41 ?image. }
                    UNION
                    { ?item wdt:P94 ?image. }
                    
                    SERVICE wikibase:mwapi {
                        bd:serviceParam wikibase:endpoint "www.wikidata.org".
                        bd:serviceParam wikibase:api "Generator".
                        bd:serviceParam mwapi:generator "search".
                        bd:serviceParam mwapi:gensprop "none".
                        bd:serviceParam mwapi:gensearch "${keyword}".
                        ?item wikibase:apiOutputItem mwapi:title.
                    }
                    
                    OPTIONAL { ?item wdt:P170 ?author. } 
                    OPTIONAL { ?item wdt:P6216 ?license. } 
                    OPTIONAL { ?item wdt:P580 ?startDate. } 
                    OPTIONAL { ?item wdt:P582 ?endDate. } 
                    
                    SERVICE wikibase:label { 
                        bd:serviceParam wikibase:language "[AUTO_LANGUAGE],ja,en".
                        ?item rdfs:label ?itemLabel.
                        OPTIONAL { ?item wdt:P31 ?typeQID. ?typeQID rdfs:label ?type. }
                        OPTIONAL { ?license rdfs:label ?licenseLabel. }
                        OPTIONAL { ?author rdfs:label ?authorLabel. }
                    }
                }
                GROUP BY ?item ?itemLabel ?image ?licenseLabel ?authorLabel
                LIMIT 50
            `;
            return sparqlQuery;
        }

        function transformWikidataResponse(data) {
            // ... (çœç•¥: å‰ã®å›ç­”ã®transformWikidataResponseé–¢æ•°ã‚’ãã®ã¾ã¾åˆ©ç”¨)
            if (!data.results || !data.results.bindings) return [];
            
            const flags = data.results.bindings.map(binding => {
                let licenseName = binding.licenseLabel?.value || 'ä¸æ˜ãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹';
                let licenseUrl = '';
                if (licenseName.includes('Creative Commons')) {
                    licenseUrl = 'https://creativecommons.org/licenses/by-sa/4.0/deed.ja';
                } else if (licenseName.includes('Public Domain')) {
                    licenseUrl = 'https://ja.wikipedia.org/wiki/%E3%83%91%E3%83%96%E3%83%AA%E3%83%83%E3%82%AF%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3';
                }
                let startDate = binding.start?.value ? new Date(binding.start.value).getFullYear() : 'ä¸æ˜';
                let endDate = binding.end?.value ? new Date(binding.end.value).getFullYear() : null;
                let typeLabel = binding.typeLabel?.value || 'æ——/ç´‹ç« ';
                let simpleType = typeLabel.includes('ç´‹ç« ') || typeLabel.includes('Coat of arms') ? 'å›½ç« ' : 'æ——';
                const id = binding.itemLabel?.value + '_' + startDate; 
                
                return {
                    id: id,
                    name: binding.itemLabel?.value || 'åç§°ä¸æ˜',
                    type: simpleType,
                    start_year: startDate,
                    end_year: endDate,
                    image_url: binding.image?.value,
                    license_name: licenseName,
                    license_url: licenseUrl,
                    author: binding.authorLabel?.value || 'ä¸æ˜',
                    source: 'Wikidata'
                };
            });
            return flags;
        }


        // =======================================================
        // ğŸ¨ è¡¨ç¤ºå‡¦ç†é–¢æ•° (DOWNLOAD LINKå¯¾å¿œæ¸ˆã¿)
        // =======================================================

        function renderFlags(flags, container) {
            // ... (çœç•¥: å‰ã®å›ç­”ã®renderFlagsé–¢æ•°ã‚’ãã®ã¾ã¾åˆ©ç”¨)
            container.innerHTML = '';
            flags.forEach(flag => {
                const card = document.createElement('div');
                card.className = 'flag-card';
                
                const imageUrl = flag.image_url || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="10" fill="#cc0000">ç”»åƒæ¬ è½</text><rect x="0" y="0" width="100" height="100" fill="none" stroke="#ccc" stroke-width="2"/></svg>';
                
                const safeFileName = `${flag.name.replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '_')}_${flag.start_year}`;

                const downloadSection = `
                    <a href="${imageUrl}" download="${safeFileName}.svg" title="${flag.name}ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                        <img src="${imageUrl}" alt="${flag.name}">
                    </a>
                    <button onclick="window.open('${imageUrl}', '_blank')">ç”»åƒã‚’åˆ¥ã‚¿ãƒ–ã§é–‹ã</button>
                `;

                card.innerHTML = `
                    ${downloadSection}
                    <h3>${flag.name}</h3>
                    <p>ç¨®é¡: ${flag.type || 'ä¸æ˜'}</p>
                    <p>æœŸé–“: ${flag.start_year || 'ä¸æ˜'} - ${flag.end_year || 'ç¾è¡Œ'}</p>
                    <p style="font-size: 0.8em; color: #004d99;">ãƒ‡ãƒ¼ã‚¿å…ƒ: ${flag.source}</p>
                `;
                
                const licenseInfo = document.createElement('p');
                licenseInfo.className = 'license-info';
                
                let licenseText = 'å‡ºå…¸: ';
                licenseText += flag.author ? `ä½œè€…: ${flag.author}` : `æƒ…å ±æº`;
                
                if (flag.license_name && flag.license_url) {
                    licenseText += `, <a href="${flag.license_url}" target="_blank">${flag.license_name}</a>`;
                } else if (flag.license_name) {
                    licenseText += `, ${flag.license_name}`;
                }

                licenseInfo.innerHTML = licenseText;
                card.appendChild(licenseInfo);
                
                container.appendChild(card);
            });
        }
        
        // =======================================================
        // 3. Wikipedia Summary API (å˜ä¸€è¨˜äº‹/æ——ã®è¦ç´„ã‚’å–å¾—)
        // =======================================================

        async function fetchWikipediaSummary(query) {
            const summaryTitleElement = document.getElementById('summary-title');
            const summaryContentElement = document.getElementById('summary-content');
            
            summaryTitleElement.textContent = `${query} ã®è¨˜äº‹æ¦‚è¦...`;
            summaryContentElement.innerHTML = '';
            
            const apiUrl = `https://ja.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error('è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€APIå¿œç­”ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
                const data = await response.json();
                
                if (data.type === 'disambiguation' || data.type === 'redirect' || !data.extract) {
                    throw new Error('æŒ‡å®šã•ã‚ŒãŸè¨˜äº‹ã®è¦ç´„ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€æ›–æ˜§ã•å›é¿ãƒšãƒ¼ã‚¸ã§ã™ã€‚');
                }

                summaryTitleElement.textContent = `Wikipedia: ${data.title}`;
                
                // ãƒªãƒ³ã‚¯ã‚’çµ¶å¯¾URLã«å¤‰æ›ã—ã€æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã‚ˆã†ã«ã™ã‚‹
                let safeExtract = data.extract_html.replace(/href="\/wiki\//g, `href="https://ja.wikipedia.org/wiki/`).replace(/href="([^"]*)"/g, `href="$1" target="_blank"`);

                summaryContentElement.innerHTML = `
                    ${data.thumbnail ? `<img src="${data.thumbnail.source}" style="float:right; margin: 0 0 10px 20px; max-width: 250px; height: auto; border: 1px solid #ccc;">` : ''}
                    <p>${safeExtract}</p> 
                    <p style="clear: both; margin-top: 20px;">
                        <a href="${data.content_urls.desktop.page}" target="_blank">â†’ è©³ç´°ã‚’è¦‹ã‚‹</a>
                    </p>
                `;

            } catch (error) {
                summaryTitleElement.textContent = `Wikipedia: ${query} (è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“)`;
                summaryContentElement.innerHTML = `<p class="error-message" style="color:red;">${error.message}</p>`;
            }
        }

        // =======================================================
        // ğŸ–±ï¸ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (æ¤œç´¢å®Ÿè¡Œéƒ¨)
        // =======================================================

        document.getElementById('search-button').addEventListener('click', async () => {
            const keyword = document.getElementById('keyword-input').value.trim();
            const type = document.getElementById('flag-type-select').value;

            const flagsContainer = document.getElementById('flags-container');
            const resultCount = document.getElementById('result-count');
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');

            // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
            flagsContainer.innerHTML = '';
            resultCount.textContent = '0';
            errorMessage.classList.add('hidden');
            loadingMessage.classList.remove('hidden');

            const sparqlQuery = generateSparqlQuery(keyword, null, type);

            if (!sparqlQuery) {
                loadingMessage.classList.add('hidden');
                errorMessage.textContent = "æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                errorMessage.classList.remove('hidden');
                return;
            }
            
            let finalFlags = [];

            try {
                // 1. Wikidataæ¤œç´¢ (è¤‡æ•°ã®æ——ã‚’å–å¾—)
                const response = await fetch(WIKIDATA_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/sparql-results+json',
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
                    },
                    body: `query=${encodeURIComponent(sparqlQuery)}`
                });

                if (!response.ok) throw new Error(`Wikidataæ¥ç¶šã‚¨ãƒ©ãƒ¼ (HTTP ${response.status})`); 

                const data = await response.json();
                finalFlags = transformWikidataResponse(data); 

            } catch (error) {
                console.error('Wikidataæ¤œç´¢ã«å¤±æ•—:", error);
                loadingMessage.classList.add('hidden');
                errorMessage.textContent = "é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å¤–éƒ¨APIãŒå¿œç­”ã—ã¦ã„ã¾ã›ã‚“ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
                errorMessage.classList.remove('hidden');
                // WikidataãŒå¤±æ•—ã—ãŸå ´åˆã§ã‚‚ã€Summary APIã¯å®Ÿè¡Œã™ã‚‹
            }

            // 2. Wikipedia Summary APIã®å®Ÿè¡Œ (ä»£è¡¨çš„ãªè¨˜äº‹ã¨æ——ã‚’å–å¾—)
            await fetchWikipediaSummary(keyword);

            // 3. è¡¨ç¤º
            loadingMessage.classList.add('hidden');
            
            const uniqueFlags = Array.from(new Map(finalFlags.map(item => [item.id, item])).values());

            resultCount.textContent = uniqueFlags.length;
            renderFlags(uniqueFlags, flagsContainer);
            
            if (uniqueFlags.length === 0) {
                errorMessage.textContent = 'è©²å½“ã™ã‚‹æ——ãƒ»ç´‹ç« ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
                errorMessage.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>
